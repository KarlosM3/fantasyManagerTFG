<div class="market-container">
  <div class="market-header">
    <h1>Mercado de Jugadores</h1>
    <div class="budget-display">
      <span class="budget-label">Presupuesto disponible:</span>
      <span class="budget-amount">{{ formatMarketValue(teamBudget) }}</span>
    </div>
  </div>

  <div class="market-content" *ngIf="activeLeagueId; else noLeague">
    <div class="market-update-info">
      <span class="update-timer">{{ getTimeUntilNextUpdate() }}</span>
    </div>

    <div class="filters-section">
      <div class="filter-options">
        <div class="filter-group">
          <label for="positionFilter">Posición:</label>
          <select id="positionFilter" [(ngModel)]="positionFilter" (change)="onFilterChange()">
            <option value="all">Todas</option>
            <option value="1">Portero</option>
            <option value="2">Defensa</option>
            <option value="3">Centrocampista</option>
            <option value="4">Delantero</option>
          </select>
        </div>
      </div>
    </div>

    <div class="players-grid" *ngIf="!isLoading && paginatedPlayers.length > 0; else loadingOrEmpty">
      <div class="player-card" *ngFor="let player of paginatedPlayers">
        <div class="player-header">
          <span class="position-badge" [style.background-color]="getPositionColor(player.positionId)">
            {{ positionMap[player.positionId] }}
          </span>
          <img
            [src]="player.images?.transparent['256x256']"
            [alt]="player.nickname"
            class="player-image"
            (error)="player.imageError = true"
            [ngClass]="{'hidden': player.imageError}"
          />
        </div>
        <div class="player-info">
          <div class="player-name">{{ player.nickname || 'Sin nombre' }}</div>
          <div class="player-team">{{ player.team?.name }}</div>
          <div class="player-stats">
            <div class="stat">
              <div class="stat-value">{{ player.points }}</div>
              <div class="stat-label">Puntos</div>
            </div>
            <div class="stat">
              <div class="stat-value">{{ formatMarketValue(player.marketValue) }}</div>
              <div class="stat-label">Valor</div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button
            class="action-btn buy-btn"
            (click)="openBuyModal(player)"
            [disabled]="player.inMyTeam">
            {{ player.inMyTeam ? 'En tu equipo' : 'Comprar' }}
          </button>
        </div>
      </div>
    </div>

    <ng-template #loadingOrEmpty>
      <div class="players-table-container">
        <div class="loading-state" *ngIf="isLoading">
          <div class="spinner"></div>
          <p>Cargando jugadores...</p>
        </div>
        <div class="empty-state" *ngIf="!isLoading && paginatedPlayers.length === 0">
          <i class="material-icons">search_off</i>
          <p>No se encontraron jugadores</p>
        </div>
      </div>
    </ng-template>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="pagination-btn" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
        <i class="material-icons">chevron_left</i>
      </button>
      <span class="page-info">Página {{ currentPage }} de {{ totalPages }}</span>
      <button class="pagination-btn" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
        <i class="material-icons">chevron_right</i>
      </button>
    </div>
  </div>

  <ng-template #noLeague>
    <div class="no-league-message">
      <div class="message-content">
        <i class="material-icons">sports_soccer</i>
        <p>Necesitas seleccionar una liga para ver el mercado de jugadores.</p>
        <button class="primary-btn" routerLink="/layouts/home">Ir a mis ligas</button>
      </div>
    </div>
  </ng-template>

  <!-- Modal de compra -->
  <div class="modal" *ngIf="showBuyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Comprar Jugador</h2>
        <button class="close-btn" (click)="closeBuyModal()">×</button>
      </div>
      <div class="modal-body" *ngIf="selectedPlayer">
        <div class="player-info">
          <div class="player-name">{{ selectedPlayer.name }}</div>
          <div class="player-details">
            <span class="position-badge" [style.background-color]="getPositionColor(selectedPlayer.positionId)">
              {{ positionMap[selectedPlayer.positionId] }}
            </span>
            <span class="team-name">{{ selectedPlayer.team?.name || 'Sin equipo' }}</span>
          </div>
          <div class="player-value">
            <span class="value-label">Valor de mercado:</span>
            <span class="value-amount">{{ formatMarketValue(selectedPlayer.marketValue) }}</span>
          </div>
        </div>

        <div class="budget-info">
          <div class="budget-row">
            <span>Presupuesto actual:</span>
            <span>{{ formatMarketValue(teamBudget) }}</span>
          </div>
          <div class="budget-row">
            <span>Coste del jugador:</span>
            <span>-{{ formatMarketValue(selectedPlayer.marketValue) }}</span>
          </div>
          <div class="budget-row total">
            <span>Presupuesto restante:</span>
            <span>{{ formatMarketValue(teamBudget - selectedPlayer.marketValue) }}</span>
          </div>
        </div>

        <div class="confirmation-message">
          <p>¿Estás seguro de que quieres comprar a este jugador?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeBuyModal()">Cancelar</button>
        <button
          class="confirm-btn"
          [disabled]="!selectedPlayer || teamBudget < selectedPlayer.marketValue"
          (click)="buyPlayer()"
        >
          Confirmar Compra
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de venta -->
  <div class="modal" *ngIf="showSellModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Vender Jugador</h2>
        <button class="close-btn" (click)="closeSellModal()">×</button>
      </div>
      <div class="modal-body" *ngIf="selectedPlayer">
        <div class="player-info">
          <div class="player-name">{{ selectedPlayer.name }}</div>
          <div class="player-details">
            <span class="position-badge" [style.background-color]="getPositionColor(selectedPlayer.positionId)">
              {{ positionMap[selectedPlayer.positionId] }}
            </span>
            <span class="team-name">{{ selectedPlayer.team?.name || 'Sin equipo' }}</span>
          </div>
          <div class="player-value">
            <span class="value-label">Valor de venta:</span>
            <span class="value-amount">{{ formatMarketValue(selectedPlayer.marketValue) }}</span>
          </div>
        </div>

        <div class="budget-info">
          <div class="budget-row">
            <span>Presupuesto actual:</span>
            <span>{{ formatMarketValue(teamBudget) }}</span>
          </div>
          <div class="budget-row">
            <span>Valor de venta:</span>
            <span>+{{ formatMarketValue(selectedPlayer.marketValue) }}</span>
          </div>
          <div class="budget-row total">
            <span>Nuevo presupuesto:</span>
            <span>{{ formatMarketValue(teamBudget + selectedPlayer.marketValue) }}</span>
          </div>
        </div>

        <div class="confirmation-message">
          <p>¿Estás seguro de que quieres vender a este jugador?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeSellModal()">Cancelar</button>
        <button class="confirm-btn" (click)="sellPlayer()">Confirmar Venta</button>
      </div>
    </div>
  </div>
</div>


